# 第六章：给项目拍一张全景照片

---
这一章要做的就是这件事：**站远一点，给整个房间拍一张全景照。**

---

## 什么是 Layer-Zone Tree

Layer-Zone Tree 是你项目的全景照片。

它是一份文档——把所有 Layer、所有 Zone、每个 Zone 的职责、包含的文件、Zone 之间的依赖关系，全部汇总在一起。一份文档，回答六个问题：

1. 项目有几个 Layer？
2. 每个 Layer 有哪些 Zone？
3. 每个 Zone 负责什么？
4. 哪些文件属于每个 Zone？
5. Zone 之间有什么依赖关系？
6. 有没有文件不属于任何 Zone？

六个问题全答完，你对项目的全局认知就重建了。不是"大概知道"，是"看得清清楚楚"。

上一章说了，这份文档不需要你手动写——把 AI Playbook 和源码丢给 AI，AI 会自动输出两份文件：

- **Layer-Zone Tree**：文字版全景照，结构化数据。
- **Layer-Zone Visuals**：图表版全景照，Mermaid 可视化。

这一章我们来看看这两份文件里到底有什么。

---

## Tree 长什么样

直接看 GetDone Timer 的真实 Tree。AI 分析了 160 个 Swift 文件之后，输出的结构概览是这样的：

```
GetDoneTimerV1 — Layer-Zone Tree

🚀 Core Layer
├─ BootstrapZone [组织型]  — Core.Z1
│  "应用启动、DI 容器组装、生命周期管理"
│  包含：main, AppDelegate, AppZone, AppSecrets

📱 UI Layer
├─ MainWindowZone [组织型]  — UI.Z1
├─ SidebarUIZone [执行型]   — UI.Z2
├─ CardUIZone [执行型]      — UI.Z3    (15个文件)
├─ ScheduleUIZone [执行型]  — UI.Z4    (19个文件)
├─ AIAssistantUIZone [执行型] — UI.Z5  (14个文件)
├─ AccountUIZone [执行型]   — UI.Z6    (9个文件)
├─ SettingsUIZone [执行型]  — UI.Z7
├─ DialogUIZone [执行型]    — UI.Z8    (11个文件)
├─ GroupUIZone [执行型]     — UI.Z9
├─ MenuBarUIZone [执行型]   — UI.Z10
└─ StatisticsUIZone [执行型] — UI.Z11  (10个文件)

🔗 Glue Layer
├─ TaskGlueZone       — G.Z1
├─ ScheduleGlueZone   — G.Z2
├─ AIGlueZone         — G.Z3
├─ AccountGlueZone    — G.Z4
└─ StatisticsGlueZone — G.Z5

💼 Logic Layer
├─ TaskZone          — L.Z1
├─ TimingZone        — L.Z2
├─ ScheduleZone      — L.Z3
├─ AccountZone       — L.Z4
├─ AIZone            — L.Z5
├─ GroupZone         — L.Z6
├─ SettingsZone      — L.Z7
├─ StatisticsZone    — L.Z8
├─ PaymentZone       — L.Z9
├─ PermissionZone    — L.Z10
├─ NotificationZone  — L.Z11
└─ HotkeyZone        — L.Z12

💾 Data Layer
├─ PersistenceZone     — D.Z1
├─ UserDataZone        — D.Z2
├─ AIDataZone          — D.Z3
└─ ScheduleDataZone    — D.Z4

📦 Models（跨层共享，24个文件）
└─ 全部为纯值类型，无 Zone
```

160 个文件。6 个 Layer。33 个 Zone。一页纸上全部展开。

注意每个 Zone 的编号：UI.Z3、L.Z1、D.Z2……前缀是 Layer 缩写，后面是序号。一看编号就知道这个 Zone 在哪一层。在后续所有的依赖分析、违规报告里，编号就是定位坐标。

---

## 照片里能看到什么

Tree 不只是一份清单。它是一份诊断报告。

AI 分析完之后，除了结构概览，还会输出几张具体的"体检表"。来看看 GetDone Timer 的 Tree 里都发现了什么。

### 依赖关系：谁跟谁有关系

Tree 里有一张完整的依赖合规表。每条 Zone 间的依赖都被列出来，并标注了是否合规：

```
✅ 合规：UI.Z3 CardUIZone → G.Z1 TaskGlueZone
✅ 合规：G.Z1 TaskGlueZone → L.Z1 TaskZone, L.Z2 TimingZone
✅ 合规：L.Z1 TaskZone → D.Z1 PersistenceZone
```

界面层依赖 Glue 层，Glue 层依赖逻辑层，逻辑层依赖数据层——方向全部向下，合规。

但也有不合规的：

```
🟢 可接受：UI.Z7 SettingsUIZone → L.Z7 SettingsZone
   （设置界面直接读 SettingsManager，跳过了 Glue 层，但场景简单，不需要加 ViewModel）

🟡 需关注：G.Z3 AIGlueZone → D.Z3 AIDataZone
   （Glue 层直接访问 Data 层，跳过了 Logic 层。当前是纯 CRUD，风险可控，
    但如果后续对话历史需要复杂业务逻辑，应该补一个 Logic 层中转）
```

GetDone Timer 的 160 个文件、27 条依赖关系里：24 条合规，2 条 🟢，1 条 🟡，0 条 🔴。架构整体健康。

**这些信息你之前看得见吗？** 看不见。它们藏在代码里，藏在文件之间的 import 语句里。你不可能靠脑子记住 27 条依赖关系的合规状态。但 Tree 替你看了，替你标了，替你分了级。

### 膨胀的 Zone：哪个箱子太满了

Tree 附带一张 Zone 详情表，列出每个 Zone 的文件数量：

| Zone | 文件数 |
|:---|---:|
| UI.Z4 ScheduleUIZone | 19 |
| UI.Z3 CardUIZone | 15 |
| UI.Z5 AIAssistantUIZone | 14 |
| UI.Z8 DialogUIZone | 11 |
| UI.Z11 StatisticsUIZone | 10 |

ScheduleUIZone 有 19 个文件——是整个项目最大的 Zone。上一章说过，超过 10-15 个文件就该考虑拆分。这里一眼就能看到哪些箱子在膨胀。

### 迷路的文件：放错位置的东西

这是最有意思的部分。AI 不是按文件夹分类的——它是读完代码内容之后，根据代码实际做的事情来判断归属。这意味着它能发现**物理位置和逻辑归属不一致**的文件。

GetDone Timer 的 Tree 里标出了几个偏差：

| 物理位置 | 逻辑归属 | 什么情况 |
|:---|:---|:---|
| Logic/GoogleSignInWindow | UI.Z6 AccountUIZone | 一个 UI 组件放在了 Logic 目录——它是 WKWebView OAuth 窗口，纯界面代码 |
| MainWindow/Schedule/ScheduleCoordinator | G.Z2 ScheduleGlueZone | 一个 Glue 层的 Coordinator 放在了 UI 目录 |
| MainWindow/AIAssistant/.../ConversationRecord | Models Layer | 一个纯数据模型放在了 UI 目录 |

这些"迷路的文件"你之前知道吗？大概率不知道。它们不会导致编译错误，不会让应用崩溃，但它们在悄悄污染你的架构——一个 UI 组件混在逻辑层里，下次你让 AI "改逻辑层的认证流程"，AI 可能会连这个 UI 文件一起改。

**Tree 把这些隐藏的问题变成了可见的问题。** 看见了，你才能决定要不要处理。

### 归属待定：AI 也拿不准的文件

有些文件，AI 分析完之后觉得"放哪个 Zone 都有道理"，它不会硬塞——而是列出候选方案，让你决定：

| 文件 | 候选 A | 候选 B | 原因 |
|:---|:---|:---|:---|
| GoogleSignInWindow | L.Z4 AccountZone | UI.Z6 AccountUIZone | 物理在 Logic 但内容是 UI 组件 |
| ConversationRecord | UI.Z5 AIAssistantUIZone | Models Layer | 物理在 UI 但本质是纯数据模型 |

AI 做分析，你做决策。这个分工在 Tree 的每一个环节都一致。

---

## Visuals：图表版全景照

Tree 是文字版的全景照——详细、完整、适合审核和查阅。但有时候你需要的不是细节，而是一眼看到全局。

这就是 Visuals 文件的作用。它把 Tree 里的信息转化成 Mermaid 图表，在 Obsidian、GitHub、VS Code 里直接渲染。

GetDone Timer 的 Visuals 里有几张关键的图。

**层级总览图**：一张图看到所有 Layer 和所有 Zone 的分布。Core 层 1 个 Zone，UI 层 11 个 Zone，Glue 层 5 个 Zone，Logic 层 12 个 Zone，Data 层 4 个 Zone。项目的"骨架"一目了然。

**依赖关系图**：所有 Zone 之间的依赖连线画出来，合规的用实线，违规的用虚线加颜色标注。你不需要逐条看合规表——扫一眼图，虚线在哪里，问题就在哪里。

**功能切片图**：选一个功能（比如"任务管理"），看它从 UI 到 Data 怎么贯穿：

```
UI.Z3 CardUIZone (15) → G.Z1 TaskGlueZone (4) → L.Z1 TaskZone (2) → D.Z1 PersistenceZone (2)
```

一个功能在四个层各有多少文件、怎么串联——一条线画清楚。

**文件分布饼图**：160 个文件在各层的分布——UI 层 89 个（56%），Logic 层 30 个，Models 24 个，Glue 层 14 个，Data 层 7 个。如果某一层占比异常大，说明那一层可能需要更细的 Zone 拆分。

Tree 和 Visuals 是同一张照片的两种呈现方式。Tree 是数据源，你审核细节用它。Visuals 是可视化，你看全局用它。

---

## 统计摘要：一张照片的数据指纹

Tree 的最后还有一个统计摘要——用几个数字概括整张照片的关键信息：

```
Layer 数量：6（Core + UI + Glue + Logic + Data + Models）
Zone 总数：33（执行型 31 + 组织型 2）

文件总数：~160
  Zone 内：~148
  非 Zone：~7
  Models（跨层共享）：24
  归属待定：2

依赖关系数：27
  ✅ 合规：24
  🟢 可接受：2
  🟡 需关注：1
  🔴 必须修复：0
```

这几个数字就是你项目的"体检报告摘要"。下次 AI 重新拍照的时候，你对比两次的摘要——Zone 数量变了吗？违规增加了吗？有没有新的 🔴？——变化一目了然。

---

## 看见，就是解决问题的一半

回到前言里讲过的那个困境：项目越来越大，你看不清它长什么样了。

Layer-Zone Tree 就是答案。它不帮你写代码，不帮你修 bug，不帮你加功能——它只做一件事：**让你看见。**

看见项目有几层，每层有哪些 Zone。看见 Zone 之间的依赖关系，哪些合规，哪些违规。看见哪个 Zone 在膨胀，哪个文件放错了位置。看见整个项目从 160 个散落的文件变成一张有结构、有标签、有关系的全景图。

你不需要记住每一行代码——AI 记得。

你只需要看得清全局——Tree 帮你看。

**指挥官有了地图，精锐部队才能发挥最大战力。**

---

**本章小结**

> Layer-Zone Tree 是你项目的全景照片。它回答六个问题：几层、几个 Zone、各自负责什么、包含哪些文件、依赖关系、有没有遗漏。
>
> Tree 不只是清单，还是诊断报告：合规/违规的依赖、膨胀的 Zone、迷路的文件、归属待定的边界案例——全部可见。
>
> Visuals 文件把 Tree 的信息变成图表：层级总览、依赖关系图、功能切片、文件分布——一眼看全局。
>
> 但最酷的是——你不需要自己拍这张照片。上一章已经说了，AI Playbook + 源码丢给 AI，Tree 和 Visuals 就出来了。下一章，我们来看看怎么让 AI 帮你定期拍照，持续掌控项目的变化。
