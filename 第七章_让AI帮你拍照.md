# 第七章：让 AI 帮你拍照

---

上一章看了全景照片里有什么。这一章讲怎么拍。

三种拍法，适用于三个不同的场景。看完之后你就知道什么时候该拍、怎么拍、拍完怎么用。

---

## 三种拍照方式

### Bottom-up：给现有项目拍照

**场景**：你的项目已经有了一堆代码，你想看清它现在长什么样。

这是最常用的方式。项目 Vibe Coding 到一定阶段，代码膨胀到你脑子装不下了，你需要一张现状照片。

做法很简单：把 AI Playbook 和项目源码一起丢给 AI。AI 从代码出发，逆向分析出整个 Layer-Zone 结构，输出 Tree 和 Visuals。

就是"推开门，给房间拍一张现状照"。不管房间多乱，先拍下来，看清楚再说。

### Top-down：给新项目画蓝图

**场景**：你要开始一个新项目，想在写代码之前先把收纳系统规划好。

这时候还没有代码，没法从代码逆向推导。方向反过来——从需求出发，先设计 Layer-Zone Tree，再让 AI 按照 Tree 来写代码。

做法：列出项目的核心功能（比如：任务管理、计时、通知、数据存储），每个功能对应一个初始 Zone，确定 Layer 划分，规划好依赖关系，输出一份设计版的 Tree。

这相当于"装修之前先画设计图"。从第一天就有全景照，代码按照蓝图生长，不会积累黑箱。

### Calibration：两张照片的对比

**场景**：你已经有了一份 Tree（不管是 Bottom-up 拍的还是 Top-down 设计的），继续 Vibe Coding 了一段时间，想看看项目变了多少。

这是最有价值的方式。

做法：让 AI 重新做一次 Bottom-up 分析，得到一份新的 Tree。然后把新旧两份 Tree 放在一起对比，AI 输出一份差异报告。

看个例子。假设 GetDone Timer 在 1 月份拍了一张照片，3 月份又拍了一张：

```
1月份的照片：
  Logic Layer：5 个 Zone，最大的 Zone 有 8 个文件
  依赖违规：0 条

3月份的照片：
  Logic Layer：7 个 Zone，最大的 Zone 有 14 个文件
  依赖违规：2 条

对比发现：
  ✅ 新增了 AIZone 和 StatisticsZone —— 功能增长，正常
  🟡 TaskZone 从 8 个文件膨胀到 14 个 —— 考虑拆分
  🔴 出现了一条 Logic → UI 的反向依赖 —— 必须修
  ⚠️ 两个工具文件跑到了 Logic 层 —— 应该标为 Non-Zone
```

两张照片一放，变化一目了然。哪些是正常增长，哪些是需要注意的膨胀，哪些是必须处理的问题——全都看得见。

**这才是 Vibe Coding 最需要的节奏**：不是每加一个功能就停下来检查架构，而是定期拍一张照片，跟上次对比，看看项目往哪个方向在走。不打断你的 flow，但让你持续掌控全局。

---

## Bottom-up：AI 怎么拍这张照片

三种方式里 Bottom-up 最常用，展开讲讲 AI 具体做了什么。

你丢给 AI 的是 AI Playbook + 源码。AI 拿到之后，按照 Playbook 里定义的规则，走八个步骤：

**Step 1：扫描所有源文件**

AI 列出项目里每一个代码文件的名称和路径。这一步是纯清点——先看看房间里到底有多少东西。

**Step 2：判断 Layer 结构**

从基础三层（UI / Logic / Data）开始，AI 看项目里有没有信号需要增加扩展层：有独立的 ViewModels 目录且文件够多？加 Glue 层。有独立的启动 / DI 容器代码？加 Core 层。有大量跨层共享的纯数据模型？加 Models 层。

**Step 3：给每个文件分配 Layer**

关键点：**按代码内容分配，不是按文件夹位置。** AI 读文件的实际代码，判断它在做什么——UI 渲染？业务逻辑？数据存储？——然后分配到对应的 Layer。

这就是为什么 Tree 能发现"迷路的文件"——一个 NSWindowController 放在了 Logic 目录，AI 读完代码发现它是 UI 组件，会标注这个偏差。

**Step 4：在每个 Layer 内聚类成 Zone**

AI 在每一层内部，按"这些文件共同解决什么问题"来分组。答案就是 Zone 的名称和职责描述。分组依据是代码的实际功能，不是文件名前缀或文件夹名。

**Step 5：填写 Zone 详细信息**

每个 Zone 的名称、所属 Layer、类型（执行型/组织型）、职责描述、包含的文件列表、依赖的其他 Zone。

**Step 6：标注 Non-Zone 代码**

不属于任何 Zone 的工具函数、常量、扩展方法，列在对应 Layer 的"非 Zone 代码"清单里。AI 会用上一章讲的四条判断标准确认它们确实不需要建 Zone。

**Step 7：分析依赖关系**

这一步是 Tree 的诊断价值所在。AI 检查每个 Zone 依赖了哪些其他 Zone，方法是扫描代码里的：

- 构造注入（`init(persistence: PersistenceProtocol)`）
- 单例引用（`AccountManager.shared`）
- 协议实现
- Combine 订阅
- 通知和回调

特别要注意的是 `.shared` 单例——它会隐藏依赖关系。一个文件里写了 `AccountManager.shared.state`，就意味着它依赖 AccountZone，即使没有通过构造函数注入。

扫描完之后，AI 对每条依赖做合规判断：方向是否正确？有没有跳层？有没有反向依赖？违规的按 🟢🟡🔴 三级标注。

**Step 8：输出 Tree + Visuals**

所有分析汇总，输出两份文件。上一章看到的那些——结构概览、Zone 详情表、依赖合规表、统计摘要、迷路文件列表、归属待定表——全部在这一步生成。

八个步骤，从头到尾都是 AI 在做。你要做的就是把 Playbook 和源码丢给它，然后等结果出来审核。

---

## Calibration 怎么做

Calibration 的操作也很简单：

**第一步**：让 AI 按 Bottom-up 方式重新分析一次当前代码，得到新的 Tree。

**第二步**：把新 Tree 和旧 Tree 一起丢给 AI，让它逐项对比。

**第三步**：AI 输出差异报告，内容包括：

- 新增的 Zone（功能增长）
- 消失的 Zone（功能删除或合并）
- Zone 内文件数量变化（哪些在膨胀）
- 新增的依赖关系（有没有新的违规）
- 物理位置和逻辑归属的新偏差

你看差异报告，判断哪些变化是正常的、哪些需要处理。大多数变化是正常的——你加了新功能，自然会多出 Zone。你要关注的是异常信号：Zone 膨胀、新增违规、文件错位。

---

## 什么时候该拍照

不需要每次写完代码都拍。太频繁会变成负担，太稀少又失去掌控。

**推荐节奏**：

- **每 2-4 周拍一次**，或者
- **每完成一个大功能之后拍一次**

具体取决于你 Vibe Coding 的强度。如果你一周加了三个新功能，那两周拍一次比较合适。如果你在慢慢打磨细节，四周拍一次就够了。

**几个适合拍照的时机**：

- 你刚加完一个大功能（日程模块、AI 助手、支付系统），想看看它对整体架构的影响
- 你觉得项目"开始乱了"——这个直觉通常是对的，拍张照确认一下
- 你准备开始一轮大的重构或新功能开发之前，先拍一张现状照存档
- 你要向别人（合作者、投资人、或者未来的自己）解释项目结构

**不需要拍照的时机**：

- 改了一个 bug
- 调了一个颜色
- 加了一个按钮

这些小改动不会影响架构。等它们积累到一定量，下次定期拍照的时候自然会反映出来。

核心原则：**全景照是后台运行的架构守护者，不是前台的流程审批。** 它不应该拖慢你的 Vibe Coding 节奏。你该加功能加功能，该迭代迭代——只是定期停下来拍一张照片，确认你没有偏离航线。

---

## 三种方式的选择

| 方式 | 适用场景 | 操作 |
|:---|:---|:---|
| **Bottom-up** | 已有项目，想看清现状 | Playbook + 源码 → AI 分析 → Tree + Visuals |
| **Top-down** | 新项目，想从第一天就有结构 | 需求清单 → 设计 Zone → 输出蓝图版 Tree |
| **Calibration** | 持续开发中，想看变化 | 重新 Bottom-up → 新旧 Tree 对比 → 差异报告 |

大多数 Vibe Coder 的第一次拍照是 Bottom-up——项目已经写了一堆了，想看看到底长什么样。

之后就是 Calibration 的循环——定期重新拍，跟上次对比。

Top-down 适合你开始一个全新项目、或者要加一个大型新模块的时候。

三种方式不是互斥的，它们是同一个工具在不同阶段的用法。

---

**本章小结**

> 三种拍照方式：Bottom-up（给现有代码拍现状照）、Top-down（给新项目画蓝图）、Calibration（新旧照片对比看变化）。
>
> Bottom-up 是最常用的——AI 八个步骤：扫描文件 → 判断 Layer → 分配文件 → 聚类 Zone → 填写详情 → 标注 Non-Zone → 分析依赖 → 输出 Tree + Visuals。全程 AI 完成，你审核结果。
>
> Calibration 是最有价值的——定期重新拍照，新旧对比，变化一目了然。推荐每 2-4 周或每个大功能完成后拍一次。
>
> 全景照是后台的架构守护者，不是前台的流程审批。不打断你的 Vibe Coding 节奏，但让你持续掌控全局。
